<app-header></app-header>
<body>
<div class="col-2">
    <div class="bottom"><app-sidemenu></app-sidemenu></div>
</div>
<div class="col-10">
    <div class="bottom">
<H2><i class="fa fa-comment-o"></i>   <strong> ENVIAR </strong>SMS</H2>
<div class="col-12 m-auto" >
  <div class="container" >     
      <div class="row"><strong>Paso 1 :  </strong ><i>  Escoge a tu destinatario</i></div>
        
  <label for="destinatario">Buscar Persona o Lista /// Seleccionar listado  :</label>
  <div class="input-group mb-3">
    <ng-select [searchable]="true" class="col-6"
        [items]="filtros" required
        bindLabel="etiqueta"
        [clearable]=false
        placeholder="Seleccione destinatarios"
        (change)='filtrar($event)' >
      </ng-select>
      <ng-select [searchable]="true" class="input-group-append col-6"
      [items]="subfiltros" [hidden]="ocultaSubFiltro"
      bindLabel="etiqueta"
      [clearable]=false
        placeholder="Refina selección destinatarios"
        (change)='subfiltrar($event)'
		[(ngModel)]="subfiltro" >
    </ng-select>
    
  </div>
  <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#usersModal" >{{selected.length}} usuarios seleccionados</button>
  </div><p></p>
  <div class="container" > 
      <div class="row"><strong>Paso 2 :  </strong ><i>  Selecciona una categoría</i></div>
        
  <div class="form-group">
    <label for="categoria">Selecciona categoria:</label>
    <ng-select [searchable]="true" 
              [items]="categorias" required
              bindLabel="categoria"
              placeholder="Seleccione categoria"
              [(ngModel)]="categoria" >
    </ng-select>
  </div>
  </div>
  <p></p>
  <div class="container" > 
      <div class="row"><strong>Paso 3 :  </strong ><i>  Escribe tu mensaje</i></div>
     
  <div class="form-group">
    <label for="mensaje">Escriba su mensaje:</label>&nbsp;
    <span class="badge badge badge-primary" placement="top" (click)="modificar('nombre')" [ngbTooltip]="InsertaNo" >Nombre</span>&nbsp; 
    <span class="badge badge badge-success" placement="top" (click)="modificar('apellido')" [ngbTooltip]="InsertaAp" >Apellido</span>&nbsp; 
    <span class="badge badge badge-warning" placement="top" (click)="modificar('barrio')" [ngbTooltip]="InsertaBa" >Barrio</span>&nbsp; 
    <span class="badge badge badge-info" placement="top" (click)="modificar('at')" [ngbTooltip]="InsertaAt" >@</span>&nbsp; 
    <span class="badge badge badge-secondary" placement="top" (click)="modificar('firma')" [ngbTooltip]="InsertaFi" >Firma</span>
    <textarea rows="5" class="form-control" required maxlength="160" [(ngModel)]="mensaje" placeholder="Escriba Mensaje"></textarea>
     {{mensaje.length}} carácteres usados de {{ 160 - mensaje.length }} restantes    &nbsp;&nbsp; <span class="badge badge badge-danger"(click)="modificar('borrar')" [ngbTooltip]="Borrar" >Borrar</span> 

    </div>
    </div>
    <p></p>
    <div class="container" > 
        <div class="row"><strong>Paso 4 :  </strong ><i>  Enviar o Programar mensaje</i></div>
       

    <div class="form-group">
      <button data-toggle="modal" data-target="#previewModal" class="btn btn-default" (click)='cambiarTexto()'
	  [disabled]="!((selected?.length>0)&&categoria&&mensaje)">{{fecha?'Programar':'Revisar'}}</button> &nbsp; 
      <label>Programar envío</label>&nbsp; 
      <input type="datetime-local"  [(ngModel)]="fecha" />
    </div>
    <div class="alert alert-danger" [hidden]="(selected?.length>0)&&categoria&&mensaje" >
      <span [hidden]="selected?.length>0"> Debe seleccionar Destinatarios<br></span>
      <span [hidden]="categoria"> Debe seleccionar Categoria<br></span>
      <span [hidden]="mensaje"> Debe escribir mensaje</span>
    </div>
    </div>
</div>
</div>
</div>
</body>

<div class="modal fade" id="usersModal" tabindex="-1" role="dialog" aria-labelledby="usersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="usersModalLabel">Usuarios seleccionados</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ngx-datatable
          class="material"
          [rows]="newUsuarios"
          [columnMode]="'force'"
          [headerHeight]="40"
          [footerHeight]="50"
          [rowHeight]="40"
          [loadingIndicator]="loadingIndicator"
          [limit]="6"
          [selected]="selected"
          [selectionType]="'checkbox'"
          (activate)="onActivate($event)"
          (select)='onSelect($event)'>
                <ngx-datatable-column [width]="30" [sortable]="false" [canAutoResize]="false" [draggable]="false" [resizeable]="false">
                    <ng-template ngx-datatable-header-template let-value="value" let-allRowsSelected="allRowsSelected" let-selectFn="selectFn">
                        <input type="checkbox" [checked]="allRowsSelected" (change)="selectFn(!allRowsSelected)"/>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value" let-isSelected="isSelected" let-onCheckboxChangeFn="onCheckboxChangeFn">
                        <input type="checkbox" [checked]="isSelected" (change)="onCheckboxChangeFn($event)"/>
                    </ng-template>
                </ngx-datatable-column>
                <ngx-datatable-column name="Nombre">
                    <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
                          {{value}} <span [innerHTML]="row['apellidoP']"></span>
                    </ng-template>
                </ngx-datatable-column>
                <ngx-datatable-column name="Genero"></ngx-datatable-column>
                <ngx-datatable-column name="Barrio"></ngx-datatable-column>
                <ngx-datatable-column name="Organizacion"></ngx-datatable-column>
        </ngx-datatable>
                
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
        
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <h5 class="modal-title" id="usersModalLabel">Para: 
	  <select id="selector" [(ngModel)]="c2" (change)='cambiarTexto();' ><option *ngFor="let opt of selected; let i = index" [value]='i'  >{{opt.usuario}}</option></select></h5>
      <div class="modal-body">
        <div class="speech-bubble">
          <h2 style="padding:15px;">{{ cambio }}</h2>
        </div>
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-success" data-dismiss="modal" (click)="enviarMensaje()" >Enviar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>


<ng-template #InsertaFi>
    Insertar Firma Barrio
 </ng-template>
<ng-template #InsertaNo>
    Insertar Comodín Nombre
 </ng-template>
<ng-template #InsertaAp>
    Insertar Comodín Apellido
 </ng-template>
<ng-template #InsertaBa>
    Insertar Comodín Barrio
 </ng-template>
<ng-template #InsertaAt>
    Insertar Comodín '#@' para A/O según genero, Estimad#@ = Estimada o Estimado según género receptor
 </ng-template>
<ng-template #Borrar>
    Borrar Cuerpo del mensaje
 </ng-template>